THREE.SpriteCanvasMaterial=function(d){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(d,l){};this.setValues(d)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;
THREE.SpriteCanvasMaterial.prototype.clone=function(){var d=new THREE.SpriteCanvasMaterial;THREE.Material.prototype.clone.call(this,d);d.color.copy(this.color);d.program=this.program;return d};
THREE.CanvasRenderer=function(d){function g(m,b,P,e){J(b);B(P);K(e);X(m.getStyle());a.stroke();y.expandByScalar(2*b)}function l(m){L(m.getStyle());a.fill()}function r(m){c(m.target)}function c(m){if(!(m instanceof THREE.CompressedTexture)){var b=m.wrapS===THREE.RepeatWrapping,P=m.wrapT===THREE.RepeatWrapping,e=m.image,c=document.createElement("canvas");c.width=e.width;c.height=e.height;var pa=c.getContext("2d");pa.setTransform(1,0,0,-1,0,e.height);pa.drawImage(e,0,0);E[m.id]=a.createPattern(c,!0===
b&&!0===P?"repeat":!0===b&&!1===P?"repeat-x":!1===b&&!0===P?"repeat-y":"no-repeat")}}function p(m,b,P,e,pa,l,f,h,d,g,M,v,k){if(!(k instanceof THREE.DataTexture)){!1===k.hasEventListener("update",r)&&(void 0!==k.image&&0<k.image.width&&c(k),k.addEventListener("update",r));var t=E[k.id];if(void 0!==t){L(t);var t=k.offset.x/k.repeat.x,p=k.offset.y/k.repeat.y,q=k.image.width*k.repeat.x;k=k.image.height*k.repeat.y;f=(f+t)*q;h=(h+p)*k;P-=m;e-=b;pa-=m;l-=b;d=(d+t)*q-f;g=(g+p)*k-h;M=(M+t)*q-f;v=(v+p)*k-h;
k=d*v-M*g;0!==k&&(t=1/k,k=(v*P-g*pa)*t,g=(v*e-g*l)*t,P=(d*pa-M*P)*t,e=(d*l-M*e)*t,m=m-k*f-P*h,b=b-g*f-e*h,a.save(),a.transform(k,g,P,e,m,b),a.fill(),a.restore())}else L("rgba(0,0,0,1)"),a.fill()}}function b(m,a,b){var P=a.x-m.x,e=a.y-m.y,pa=P*P+e*e;0!==pa&&(b/=Math.sqrt(pa),P*=b,e*=b,a.x+=P,a.y+=e,m.x-=P,m.y-=e)}function q(m){N!==m&&(N=a.globalAlpha=m)}function da(m){C!==m&&(m===THREE.NormalBlending?a.globalCompositeOperation="source-over":m===THREE.AdditiveBlending?a.globalCompositeOperation="lighter":
m===THREE.SubtractiveBlending&&(a.globalCompositeOperation="darker"),C=m)}function J(m){H!==m&&(H=a.lineWidth=m)}function B(m){fa!==m&&(fa=a.lineCap=m)}function K(m){ua!==m&&(ua=a.lineJoin=m)}function X(m){h!==m&&(h=a.strokeStyle=m)}function L(m){s!==m&&(s=a.fillStyle=m)}function x(m){ja.length!==m.length&&(a.setLineDash(m),ja=m)}console.log("THREE.CanvasRenderer",THREE.REVISION);var qa=THREE.Math.smoothstep;d=d||{};var Y=this,sa,Z,ha,ga=new THREE.Projector,O=void 0!==d.canvas?d.canvas:document.createElement("canvas"),
ba=O.width,ka=O.height,z=Math.floor(ba/2),n=Math.floor(ka/2),aa=0,U=0,oa=ba,ea=ka,w=1,a=O.getContext("2d",{alpha:!0===d.alpha}),D=new THREE.Color(0),G=!0===d.alpha?0:1,N=1,C=0,h=null,s=null,H=null,fa=null,ua=null,ja=[],ta,A,M,t;new THREE.RenderableVertex;new THREE.RenderableVertex;var wa,ra,xa,f,k,va,v=new THREE.Color;new THREE.Color;new THREE.Color;new THREE.Color;new THREE.Color;var ya=new THREE.Color,za=new THREE.Color,Aa=new THREE.Color,E={},V,R,Ba,W,Ca,ia,na,la=new THREE.Box2,I=new THREE.Box2,
y=new THREE.Box2,e=new THREE.Color,S=new THREE.Color,ca=new THREE.Color,ma=new THREE.Vector3,m=new THREE.Vector3,P=new THREE.Vector3,pa=new THREE.Matrix3;void 0===a.setLineDash&&(a.setLineDash=function(){});this.domElement=O;this.sortElements=this.sortObjects=this.autoClear=!0;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getPixelRatio=function(){return w};this.setPixelRatio=function(m){w=m};this.setSize=function(m,a,b){ba=m*
w;ka=a*w;O.width=ba;O.height=ka;z=Math.floor(ba/2);n=Math.floor(ka/2);!1!==b&&(O.style.width=m+"px",O.style.height=a+"px");la.min.set(-z,-n);la.max.set(z,n);I.min.set(-z,-n);I.max.set(z,n);N=1;C=0;ua=fa=H=s=h=null;this.setViewport(0,0,m,a)};this.setViewport=function(m,a,b,P){aa=m*w;U=a*w;oa=b*w;ea=P*w};this.setScissor=function(){};this.enableScissorTest=function(){};this.setClearColor=function(m,a){D.set(m);G=void 0!==a?a:1;I.min.set(-z,-n);I.max.set(z,n)};this.setClearColorHex=function(m,a){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");
this.setClearColor(m,a)};this.getClearColor=function(){return D};this.getClearAlpha=function(){return G};this.getMaxAnisotropy=function(){return 0};this.clear=function(){!1===I.empty()&&(I.intersect(la),I.expandByScalar(2),I.min.x+=z,I.min.y=-I.min.y+n,I.max.x+=z,I.max.y=-I.max.y+n,1>G&&a.clearRect(I.min.x|0,I.max.y|0,I.max.x-I.min.x|0,I.min.y-I.max.y|0),0<G&&(da(THREE.NormalBlending),q(1),L("rgba("+Math.floor(255*D.r)+","+Math.floor(255*D.g)+","+Math.floor(255*D.b)+","+G+")"),a.fillRect(I.min.x|
0,I.max.y|0,I.max.x-I.min.x|0,I.min.y-I.max.y|0)),I.makeEmpty())};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(h,d){if(!1===d instanceof THREE.Camera)console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");else{!0===this.autoClear&&this.clear();Y.info.render.vertices=0;Y.info.render.faces=0;a.setTransform(oa/ba,0,0,-ea/ka,aa,ka-U);a.translate(z,n);sa=ga.projectScene(h,d,this.sortObjects,this.sortElements);
Z=sa.elements;ha=sa.lights;ta=d;pa.getNormalMatrix(d.matrixWorldInverse);e.setRGB(0,0,0);S.setRGB(0,0,0);ca.setRGB(0,0,0);for(var D=0,N=ha.length;D<N;D++){var u=ha[D],T=u.color;u instanceof THREE.AmbientLight?e.add(T):u instanceof THREE.DirectionalLight?S.add(T):u instanceof THREE.PointLight&&ca.add(T)}D=0;for(N=Z.length;D<N;D++){var F=Z[D],C=F.material;if(void 0!==C&&0!==C.opacity){y.makeEmpty();if(F instanceof THREE.RenderableSprite){A=F;A.x*=z;A.y*=n;var u=A,Q=F,T=C;q(T.opacity);da(T.blending);
var w=Q.scale.x*z,Q=Q.scale.y*n,F=.5*Math.sqrt(w*w+Q*Q);y.min.set(u.x-F,u.y-F);y.max.set(u.x+F,u.y+F);if(T instanceof THREE.SpriteMaterial){var s=T.map;if(null!==s&&void 0!==s.image){!1===s.hasEventListener("update",r)&&(0<s.image.width&&c(s),s.addEventListener("update",r));F=E[s.id];void 0!==F?L(F):L("rgba( 0, 0, 0, 1 )");var G=s.image,F=G.width*s.offset.x,C=G.height*s.offset.y,H=G.width*s.repeat.x,s=G.height*s.repeat.y,G=w/H,O=Q/s;a.save();a.translate(u.x,u.y);0!==T.rotation&&a.rotate(T.rotation);
a.translate(-w/2,-Q/2);a.scale(G,O);a.translate(-F,-C);a.fillRect(F,C,H,s)}else L(T.color.getStyle()),a.save(),a.translate(u.x,u.y),0!==T.rotation&&a.rotate(T.rotation),a.scale(w,-Q),a.fillRect(-.5,-.5,1,1);a.restore()}else T instanceof THREE.SpriteCanvasMaterial&&(X(T.color.getStyle()),L(T.color.getStyle()),a.save(),a.translate(u.x,u.y),0!==T.rotation&&a.rotate(T.rotation),a.scale(w,Q),T.program(a),a.restore())}else if(F instanceof THREE.RenderableLine){if(A=F.v1,M=F.v2,A.positionScreen.x*=z,A.positionScreen.y*=
n,M.positionScreen.x*=z,M.positionScreen.y*=n,y.setFromPoints([A.positionScreen,M.positionScreen]),!0===la.isIntersectionBox(y))if(u=A,T=M,w=F,Q=C,q(Q.opacity),da(Q.blending),a.beginPath(),a.moveTo(u.positionScreen.x,u.positionScreen.y),a.lineTo(T.positionScreen.x,T.positionScreen.y),Q instanceof THREE.LineBasicMaterial){J(Q.linewidth);B(Q.linecap);K(Q.linejoin);if(Q.vertexColors!==THREE.VertexColors)X(Q.color.getStyle());else if(F=w.vertexColors[0].getStyle(),w=w.vertexColors[1].getStyle(),F===w)X(F);
else{try{var fa=a.createLinearGradient(u.positionScreen.x,u.positionScreen.y,T.positionScreen.x,T.positionScreen.y);fa.addColorStop(0,F);fa.addColorStop(1,w)}catch(ja){fa=F}X(fa)}a.stroke();y.expandByScalar(2*Q.linewidth)}else Q instanceof THREE.LineDashedMaterial&&(J(Q.linewidth),B(Q.linecap),K(Q.linejoin),X(Q.color.getStyle()),x([Q.dashSize,Q.gapSize]),a.stroke(),y.expandByScalar(2*Q.linewidth),x([]))}else if(F instanceof THREE.RenderableFace){A=F.v1;M=F.v2;t=F.v3;if(-1>A.positionScreen.z||1<A.positionScreen.z)continue;
if(-1>M.positionScreen.z||1<M.positionScreen.z)continue;if(-1>t.positionScreen.z||1<t.positionScreen.z)continue;A.positionScreen.x*=z;A.positionScreen.y*=n;M.positionScreen.x*=z;M.positionScreen.y*=n;t.positionScreen.x*=z;t.positionScreen.y*=n;0<C.overdraw&&(b(A.positionScreen,M.positionScreen,C.overdraw),b(M.positionScreen,t.positionScreen,C.overdraw),b(t.positionScreen,A.positionScreen,C.overdraw));y.setFromPoints([A.positionScreen,M.positionScreen,t.positionScreen]);if(!0===la.isIntersectionBox(y)){T=
A;w=M;Q=t;u=C;Y.info.render.vertices+=3;Y.info.render.faces++;q(u.opacity);da(u.blending);wa=T.positionScreen.x;ra=T.positionScreen.y;xa=w.positionScreen.x;f=w.positionScreen.y;k=Q.positionScreen.x;va=Q.positionScreen.y;var C=wa,H=ra,s=xa,G=f,O=k,ua=va;a.beginPath();a.moveTo(C,H);a.lineTo(s,G);a.lineTo(O,ua);a.closePath();if((u instanceof THREE.MeshLambertMaterial||u instanceof THREE.MeshPhongMaterial)&&null===u.map){ya.copy(u.color);za.copy(u.emissive);u.vertexColors===THREE.FaceColors&&ya.multiply(F.color);
v.copy(e);m.copy(T.positionWorld).add(w.positionWorld).add(Q.positionWorld).divideScalar(3);T=m;w=F.normalModel;Q=v;F=0;for(C=ha.length;F<C;F++)H=ha[F],Aa.copy(H.color),H instanceof THREE.DirectionalLight?(s=ma.setFromMatrixPosition(H.matrixWorld).normalize(),G=w.dot(s),0>=G||(G*=H.intensity,Q.add(Aa.multiplyScalar(G)))):H instanceof THREE.PointLight&&(s=ma.setFromMatrixPosition(H.matrixWorld),G=w.dot(ma.subVectors(s,T).normalize()),0>=G||(G*=0==H.distance?1:1-Math.min(T.distanceTo(s)/H.distance,
1),0!=G&&(G*=H.intensity,Q.add(Aa.multiplyScalar(G)))));v.multiply(ya).add(za);!0===u.wireframe?g(v,u.wireframeLinewidth,u.wireframeLinecap,u.wireframeLinejoin):l(v)}else u instanceof THREE.MeshBasicMaterial||u instanceof THREE.MeshLambertMaterial||u instanceof THREE.MeshPhongMaterial?null!==u.map?u.map.mapping===THREE.UVMapping&&(V=F.uvs,p(wa,ra,xa,f,k,va,V[0].x,V[0].y,V[1].x,V[1].y,V[2].x,V[2].y,u.map)):null!==u.envMap?u.envMap.mapping===THREE.SphericalReflectionMapping&&(P.copy(F.vertexNormalsModel[0]).applyMatrix3(pa),
R=.5*P.x+.5,Ba=.5*P.y+.5,P.copy(F.vertexNormalsModel[1]).applyMatrix3(pa),W=.5*P.x+.5,Ca=.5*P.y+.5,P.copy(F.vertexNormalsModel[2]).applyMatrix3(pa),ia=.5*P.x+.5,na=.5*P.y+.5,p(wa,ra,xa,f,k,va,R,Ba,W,Ca,ia,na,u.envMap)):(v.copy(u.color),u.vertexColors===THREE.FaceColors&&v.multiply(F.color),!0===u.wireframe?g(v,u.wireframeLinewidth,u.wireframeLinecap,u.wireframeLinejoin):l(v)):(u instanceof THREE.MeshDepthMaterial?v.r=v.g=v.b=1-qa(T.positionScreen.z*T.positionScreen.w,ta.near,ta.far):u instanceof THREE.MeshNormalMaterial?
(P.copy(F.normalModel).applyMatrix3(pa),v.setRGB(P.x,P.y,P.z).multiplyScalar(.5).addScalar(.5)):v.setRGB(1,1,1),!0===u.wireframe?g(v,u.wireframeLinewidth,u.wireframeLinecap,u.wireframeLinejoin):l(v))}}I.union(y)}}a.setTransform(1,0,0,1,0,0)}}};THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0};
THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.z=0};
THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=!0};THREE.RenderableVertex.prototype.copy=function(d){this.positionWorld.copy(d.positionWorld);this.positionScreen.copy(d.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.z=0};
THREE.RenderableSprite=function(){this.id=0;this.object=null;this.rotation=this.z=this.y=this.x=0;this.scale=new THREE.Vector2;this.material=null};
THREE.Projector=function(){function d(){if(K===L){var a=new THREE.RenderableVertex;X.push(a);L++;K++;return a}return X[K++]}function g(){if(qa===sa){var a=new THREE.RenderableFace;Y.push(a);sa++;qa++;return a}return Y[qa++]}function l(){if(ha===O){var a=new THREE.RenderableLine;ga.push(a);O++;ha++;return a}return ga[ha++]}function r(){if(ka===n){var a=new THREE.RenderableSprite;z.push(a);n++;ka++;return a}return z[ka++]}function c(a,b){return a.z!==b.z?b.z-a.z:a.id!==b.id?a.id-b.id:0}function p(a,
b){var c=0,l=1,d=a.z+a.w,f=b.z+b.w,k=-a.z+a.w,h=-b.z+b.w;if(0<=d&&0<=f&&0<=k&&0<=h)return!0;if(0>d&&0>f||0>k&&0>h)return!1;0>d?c=Math.max(c,d/(d-f)):0>f&&(l=Math.min(l,d/(d-f)));0>k?c=Math.max(c,k/(k-h)):0>h&&(l=Math.min(l,k/(k-h)));if(l<c)return!1;a.lerp(b,c);b.lerp(a,1-l);return!0}var b,q,da=[],J=0,B,K,X=[],L=0,x,qa,Y=[],sa=0,Z,ha,ga=[],O=0,ba,ka,z=[],n=0,aa={objects:[],lights:[],elements:[]},U=new THREE.Vector3,oa=new THREE.Vector3,ea=new THREE.Vector3,w=new THREE.Vector3,a=new THREE.Vector4,D=
new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),G=new THREE.Box3,N=Array(3),C=new THREE.Matrix4,h=new THREE.Matrix4,s,H=new THREE.Matrix4,fa=new THREE.Matrix3,ua=new THREE.Frustum,ja=new THREE.Vector4,ta=new THREE.Vector4;this.projectVector=function(a,b){console.warn("THREE.Projector: .projectVector() is now vector.project().");a.project(b)};this.unprojectVector=function(a,b){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");a.unproject(b)};this.pickingRay=
function(a,b){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var A=new function(){var a=[],b=[],c=null,r=null,p=new THREE.Matrix3,f=function(a){var b=a.positionWorld,c=a.positionScreen;b.copy(a.position).applyMatrix4(s);c.copy(b).applyMatrix4(h);b=1/c.w;c.x*=b;c.y*=b;c.z*=b;a.visible=-1<=c.x&&1>=c.x&&-1<=c.y&&1>=c.y&&-1<=c.z&&1>=c.z},k=function(a,b,c){if(!0===a.visible||!0===b.visible||!0===c.visible)return!0;N[0]=a.positionScreen;N[1]=b.positionScreen;N[2]=c.positionScreen;
return D.isIntersectionBox(G.setFromPoints(N))},q=function(a,b,c){return 0>(c.positionScreen.x-a.positionScreen.x)*(b.positionScreen.y-a.positionScreen.y)-(c.positionScreen.y-a.positionScreen.y)*(b.positionScreen.x-a.positionScreen.x)};return{setObject:function(l){c=l;r=c.material;p.getNormalMatrix(c.matrixWorld);a.length=0;b.length=0},projectVertex:f,checkTriangleVisibility:k,checkBackfaceCulling:q,pushVertex:function(a,b,c){B=d();B.position.set(a,b,c);f(B)},pushNormal:function(b,c,l){a.push(b,c,
l)},pushUv:function(a,c){b.push(a,c)},pushLine:function(a,b){var d=X[a],h=X[b];Z=l();Z.id=c.id;Z.v1.copy(d);Z.v2.copy(h);Z.z=(d.positionScreen.z+h.positionScreen.z)/2;Z.material=c.material;aa.elements.push(Z)},pushTriangle:function(l,d,h){var f=X[l],D=X[d],s=X[h];if(!1!==k(f,D,s)&&(r.side===THREE.DoubleSide||!0===q(f,D,s))){x=g();x.id=c.id;x.v1.copy(f);x.v2.copy(D);x.v3.copy(s);x.z=(f.positionScreen.z+D.positionScreen.z+s.positionScreen.z)/3;for(f=0;3>f;f++)D=3*arguments[f],s=x.vertexNormalsModel[f],
s.set(a[D],a[D+1],a[D+2]),s.applyMatrix3(p).normalize(),D=2*arguments[f],x.uvs[f].set(b[D],b[D+1]);x.vertexNormalsLength=3;x.material=c.material;aa.elements.push(x)}}}};this.projectScene=function(D,t,G,z){ka=ha=qa=0;aa.elements.length=0;!0===D.autoUpdate&&D.updateMatrixWorld();void 0===t.parent&&t.updateMatrixWorld();C.copy(t.matrixWorldInverse.getInverse(t.matrixWorld));h.multiplyMatrices(t.projectionMatrix,C);ua.setFromMatrix(h);q=0;aa.objects.length=0;aa.lights.length=0;D.traverseVisible(function(m){if(m instanceof
THREE.Light)aa.lights.push(m);else if((m instanceof THREE.Mesh||m instanceof THREE.Line||m instanceof THREE.Sprite)&&!1!==m.material.visible&&(!1===m.frustumCulled||!0===ua.intersectsObject(m))){if(q===J){var a=new THREE.RenderableObject;da.push(a);J++;q++;b=a}else b=da[q++];b.id=m.id;b.object=m;w.setFromMatrixPosition(m.matrixWorld);w.applyProjection(h);b.z=w.z;aa.objects.push(b)}});!0===G&&aa.objects.sort(c);D=0;for(G=aa.objects.length;D<G;D++){var n=aa.objects[D].object,f=n.geometry;A.setObject(n);
s=n.matrixWorld;K=0;if(n instanceof THREE.Mesh)if(f instanceof THREE.BufferGeometry){var k=f.attributes,n=f.offsets;if(void 0!==k.position){for(var N=k.position.array,f=0,v=N.length;f<v;f+=3)A.pushVertex(N[f],N[f+1],N[f+2]);if(void 0!==k.normal)for(var B=k.normal.array,f=0,v=B.length;f<v;f+=3)A.pushNormal(B[f],B[f+1],B[f+2]);if(void 0!==k.uv)for(B=k.uv.array,f=0,v=B.length;f<v;f+=2)A.pushUv(B[f],B[f+1]);if(void 0!==k.index)if(k=k.index.array,0<n.length)for(D=0;D<n.length;D++)for(v=n[D],N=v.index,
f=v.start,v=v.start+v.count;f<v;f+=3)A.pushTriangle(k[f]+N,k[f+1]+N,k[f+2]+N);else for(f=0,v=k.length;f<v;f+=3)A.pushTriangle(k[f],k[f+1],k[f+2]);else for(f=0,v=N.length/3;f<v;f+=3)A.pushTriangle(f,f+1,f+2)}}else{if(f instanceof THREE.Geometry){var L=f.vertices,v=f.faces,k=f.faceVertexUvs[0];fa.getNormalMatrix(s);for(var N=n.material instanceof THREE.MeshFaceMaterial,B=!0===N?n.material:null,O=0,E=L.length;O<E;O++){var V=L[O];A.pushVertex(V.x,V.y,V.z)}L=0;for(O=v.length;L<O;L++){var E=v[L],R=!0===
N?B.materials[E.materialIndex]:n.material;if(void 0!==R){var Y=R.side,V=X[E.a],W=X[E.b],ga=X[E.c];if(!0===R.morphTargets){var ia=f.morphTargets,na=n.morphTargetInfluences,la=V.position,I=W.position,y=ga.position;U.set(0,0,0);oa.set(0,0,0);ea.set(0,0,0);for(var e=0,S=ia.length;e<S;e++){var ca=na[e];if(0!==ca){var ma=ia[e].vertices;U.x+=(ma[E.a].x-la.x)*ca;U.y+=(ma[E.a].y-la.y)*ca;U.z+=(ma[E.a].z-la.z)*ca;oa.x+=(ma[E.b].x-I.x)*ca;oa.y+=(ma[E.b].y-I.y)*ca;oa.z+=(ma[E.b].z-I.z)*ca;ea.x+=(ma[E.c].x-y.x)*
ca;ea.y+=(ma[E.c].y-y.y)*ca;ea.z+=(ma[E.c].z-y.z)*ca}}V.position.add(U);W.position.add(oa);ga.position.add(ea);A.projectVertex(V);A.projectVertex(W);A.projectVertex(ga)}if(!1!==A.checkTriangleVisibility(V,W,ga)){ia=A.checkBackfaceCulling(V,W,ga);if(Y!==THREE.DoubleSide){if(Y===THREE.FrontSide&&!1===ia)continue;if(Y===THREE.BackSide&&!0===ia)continue}x=g();x.id=n.id;x.v1.copy(V);x.v2.copy(W);x.v3.copy(ga);x.normalModel.copy(E.normal);!1!==ia||Y!==THREE.BackSide&&Y!==THREE.DoubleSide||x.normalModel.negate();
x.normalModel.applyMatrix3(fa).normalize();na=E.vertexNormals;la=0;for(I=Math.min(na.length,3);la<I;la++)y=x.vertexNormalsModel[la],y.copy(na[la]),!1!==ia||Y!==THREE.BackSide&&Y!==THREE.DoubleSide||y.negate(),y.applyMatrix3(fa).normalize();x.vertexNormalsLength=na.length;Y=k[L];if(void 0!==Y)for(ia=0;3>ia;ia++)x.uvs[ia].copy(Y[ia]);x.color=E.color;x.material=R;x.z=(V.positionScreen.z+W.positionScreen.z+ga.positionScreen.z)/3;aa.elements.push(x)}}}}}else if(n instanceof THREE.Line)if(f instanceof THREE.BufferGeometry){if(k=
f.attributes,void 0!==k.position){N=k.position.array;f=0;for(v=N.length;f<v;f+=3)A.pushVertex(N[f],N[f+1],N[f+2]);if(void 0!==k.index)for(k=k.index.array,f=0,v=k.length;f<v;f+=2)A.pushLine(k[f],k[f+1]);else for(k=n.mode===THREE.LinePieces?2:1,f=0,v=N.length/3-1;f<v;f+=k)A.pushLine(f,f+1)}}else{if(f instanceof THREE.Geometry&&(H.multiplyMatrices(h,s),L=n.geometry.vertices,0!==L.length))for(V=d(),V.positionScreen.copy(L[0]).applyMatrix4(H),k=n.mode===THREE.LinePieces?2:1,O=1,E=L.length;O<E;O++)V=d(),
V.positionScreen.copy(L[O]).applyMatrix4(H),0<(O+1)%k||(W=X[K-2],ja.copy(V.positionScreen),ta.copy(W.positionScreen),!0===p(ja,ta)&&(ja.multiplyScalar(1/ja.w),ta.multiplyScalar(1/ta.w),Z=l(),Z.id=n.id,Z.v1.positionScreen.copy(ja),Z.v2.positionScreen.copy(ta),Z.z=Math.max(ja.z,ta.z),Z.material=n.material,n.material.vertexColors===THREE.VertexColors&&(Z.vertexColors[0].copy(n.geometry.colors[O]),Z.vertexColors[1].copy(n.geometry.colors[O-1])),aa.elements.push(Z)))}else n instanceof THREE.Sprite&&(a.set(s.elements[12],
s.elements[13],s.elements[14],1),a.applyMatrix4(h),f=1/a.w,a.z*=f,-1<=a.z&&1>=a.z&&(ba=r(),ba.id=n.id,ba.x=a.x*f,ba.y=a.y*f,ba.z=a.z,ba.object=n,ba.rotation=n.rotation,ba.scale.x=n.scale.x*Math.abs(ba.x-(a.x+t.projectionMatrix.elements[0])/(a.w+t.projectionMatrix.elements[12])),ba.scale.y=n.scale.y*Math.abs(ba.y-(a.y+t.projectionMatrix.elements[5])/(a.w+t.projectionMatrix.elements[13])),ba.material=n.material,aa.elements.push(ba)))}!0===z&&aa.elements.sort(c);return aa}};
THREE.OrbitControls=function(d,g,l){function r(a){if(!1!==b.enabled){a.preventDefault();var c=b.domElement===document?b.domElement.body:b.domElement;if(n===z.ROTATE){if(!0===b.noRotate)return;da.set(a.clientX,a.clientY);J.subVectors(da,q);b.rotateLeft(2*Math.PI*J.x/c.clientWidth*b.rotateSpeed);b.rotateUp(2*Math.PI*J.y/c.clientHeight*b.rotateSpeed);q.copy(da)}else if(n===z.DOLLY){if(!0===b.noZoom)return;Y.set(a.clientX,a.clientY);sa.subVectors(Y,qa);0<sa.y?b.dollyIn():b.dollyOut();qa.copy(Y)}else if(n===
z.PAN){if(!0===b.noPan)return;K.set(a.clientX,a.clientY);X.subVectors(K,B);b.panXZ(X.x*b.panSpeed,-X.y*b.panSpeed);B.copy(K)}b.update()}}function c(){!1!==b.enabled&&(document.removeEventListener("mousemove",r,!1),document.removeEventListener("mouseup",c,!1),b.dispatchEvent(w),n=z.NONE)}function p(a){if(!1!==b.enabled&&!0!==b.noZoom){a.preventDefault();a.stopPropagation();var c=0;void 0!==a.wheelDelta?c=a.wheelDelta:void 0!==a.detail&&(c=-a.detail);0<c?b.dollyOut():b.dollyIn();b.update();b.dispatchEvent(ea);
b.dispatchEvent(w)}}this.settings=l;this.object=d;this.domElement=void 0!==g?g:document;this.enabled=!0;this.center=this.target=new THREE.Vector3;this.noZoom=!1;this.zoomSpeed=1;this.minDistance=0;this.maxDistance=Infinity;this.noRotate=!1;this.rotateSpeed=1;this.noPan=!1;this.panSpeed=.3;this.keyPanSpeed=7;this.autoRotate=!1;this.autoRotateSpeed=2;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.noKeys=!1;this.keys={LEFT:37,UP:38,RIGHT:39,
BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var b=this,q=new THREE.Vector2,da=new THREE.Vector2,J=new THREE.Vector2,B=new THREE.Vector2,K=new THREE.Vector2,X=new THREE.Vector2,L=new THREE.Vector3,x=new THREE.Vector3,qa=new THREE.Vector2,Y=new THREE.Vector2,sa=new THREE.Vector2,Z=0,ha=0,ga=1,O=new THREE.Vector3,ba=new THREE.Vector3,ka=new THREE.Quaternion,z={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},n=z.NONE;this.target0=
this.target.clone();this.position0=this.object.position.clone();var aa=(new THREE.Quaternion).setFromUnitVectors(d.up,new THREE.Vector3(0,1,0)),U=aa.clone().inverse(),oa={type:"change"},ea={type:"start"},w={type:"end"};this.rotateLeft=function(a){void 0===a&&(a=2*Math.PI/60/60*b.autoRotateSpeed);ha-=a};this.rotateUp=function(a){void 0===a&&(a=2*Math.PI/60/60*b.autoRotateSpeed);Z-=a};this.panLeft=function(a){var b=this.object.matrix.elements;L.set(b[0],b[1],b[2]);L.multiplyScalar(-a);O.add(L)};this.panUp=
function(a){var b=this.object.matrix.elements;L.set(b[4],b[5],b[6]);L.multiplyScalar(a);O.add(L)};this.panForward=function(a){var b=this.object.matrix.elements;L.set(b[8],b[9],b[10]);L.multiplyScalar(a);O.add(L)};this.pan=function(a,c){var l=b.domElement===document?b.domElement.body:b.domElement;if(void 0!==b.object.fov){var d=b.object.position.clone().sub(b.target).length(),d=d*Math.tan(b.object.fov/2*Math.PI/180);b.panLeft(2*a*d/l.clientHeight);b.panUp(2*c*d/l.clientHeight)}else void 0!==b.object.top?
(b.panLeft(a*(b.object.right-b.object.left)/l.clientWidth),b.panUp(c*(b.object.top-b.object.bottom)/l.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")};this.panXZ=function(a,c){var l=b.domElement===document?b.domElement.body:b.domElement;if(void 0!==b.object.fov){var d=b.object.position.clone().sub(b.target).length(),d=d*Math.tan(b.object.fov/2*Math.PI/180);b.panLeft(2*a*d/l.clientHeight);b.panForward(2*c*d/l.clientHeight)}else void 0!==b.object.top?
(b.panLeft(a*(b.object.right-b.object.left)/l.clientWidth),b.panForward(c*(b.object.top-b.object.bottom)/l.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")};this.dollyIn=function(a){void 0===a&&(a=Math.pow(.95,b.zoomSpeed));ga/=a};this.dollyOut=function(a){void 0===a&&(a=Math.pow(.95,b.zoomSpeed));ga*=a};this.update=function(){var a=this.object.position,c=this.settings&&this.settings.cameraAsOrbitCenter?a:this.target,l=this.settings&&this.settings.cameraAsOrbitCenter?
this.target:a;x.copy(a).sub(this.target);x.applyQuaternion(aa);var a=Math.atan2(x.x,x.z),d=Math.atan2(Math.sqrt(x.x*x.x+x.z*x.z),x.y);this.autoRotate&&this.rotateLeft(2*Math.PI/60/60*b.autoRotateSpeed);var a=a+ha,d=d+Z,a=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,a)),d=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,d)),d=Math.max(1E-6,Math.min(Math.PI-1E-6,d)),g=this.settings&&this.settings.cameraAsOrbitCenter?5E3*ga*this.settings.boxScale:x.length()*ga,g=Math.max(this.minDistance,
Math.min(this.maxDistance,g));c.add(O);x.x=g*Math.sin(d)*Math.sin(a);x.y=g*Math.cos(d);x.z=g*Math.sin(d)*Math.cos(a);x.applyQuaternion(U);this.settings&&this.settings.cameraAsOrbitCenter?l.copy(c).sub(x):l.copy(c).add(x);this.object.lookAt(this.target);Z=ha=0;ga=1;O.set(0,0,0);if(1E-6<ba.distanceToSquared(c)||1E-6<8*(1-ka.dot(this.object.quaternion)))this.dispatchEvent(oa),ba.copy(c),ka.copy(this.object.quaternion)};this.reset=function(){n=z.NONE;this.target.copy(this.target0);this.object.position.copy(this.position0);
this.update()};this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1);this.domElement.addEventListener("mousedown",function(a){if(!1!==b.enabled){a.preventDefault();if(a.button===b.mouseButtons.ORBIT){if(!0===b.noRotate)return;n=z.ROTATE;q.set(a.clientX,a.clientY)}else if(a.button===b.mouseButtons.ZOOM){if(!0===b.noZoom)return;n=z.DOLLY;qa.set(a.clientX,a.clientY)}else if(a.button===b.mouseButtons.PAN){if(!0===b.noPan)return;n=z.PAN;B.set(a.clientX,a.clientY)}document.addEventListener("mousemove",
r,!1);document.addEventListener("mouseup",c,!1);b.dispatchEvent(ea)}},!1);this.domElement.addEventListener("mousewheel",p,!1);this.domElement.addEventListener("DOMMouseScroll",p,!1);this.domElement.addEventListener("touchstart",function(a){if(!1!==b.enabled){switch(a.touches.length){case 1:if(!0===b.noRotate)return;n=z.TOUCH_ROTATE;q.set(a.touches[0].pageX,a.touches[0].pageY);break;case 2:if(!0===b.noZoom)return;n=z.TOUCH_DOLLY;var c=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;
c=Math.sqrt(c*c+a*a);qa.set(0,c);break;case 3:if(!0===b.noPan)return;n=z.TOUCH_PAN;B.set(a.touches[0].pageX,a.touches[0].pageY);break;default:n=z.NONE}b.dispatchEvent(ea)}},!1);this.domElement.addEventListener("touchend",function(){!1!==b.enabled&&(b.dispatchEvent(w),n=z.NONE)},!1);this.domElement.addEventListener("touchmove",function(a){if(!1!==b.enabled){a.preventDefault();a.stopPropagation();var c=b.domElement===document?b.domElement.body:b.domElement;switch(a.touches.length){case 1:if(!0===b.noRotate)break;
if(n!==z.TOUCH_ROTATE)break;da.set(a.touches[0].pageX,a.touches[0].pageY);J.subVectors(da,q);b.rotateLeft(2*Math.PI*J.x/c.clientWidth*b.rotateSpeed);b.rotateUp(2*Math.PI*J.y/c.clientHeight*b.rotateSpeed);q.copy(da);b.update();break;case 2:if(!0===b.noZoom)break;if(n!==z.TOUCH_DOLLY)break;c=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;a=Math.sqrt(c*c+a*a);Y.set(0,a);sa.subVectors(Y,qa);0<sa.y?b.dollyOut():b.dollyIn();qa.copy(Y);b.update();break;case 3:if(!0===b.noPan)break;
if(n!==z.TOUCH_PAN)break;K.set(a.touches[0].pageX,a.touches[0].pageY);X.subVectors(K,B);b.panXZ(X.x*b.panSpeed,-X.y*b.panSpeed);B.copy(K);b.update();break;default:n=z.NONE}}},!1);window.addEventListener("keydown",function(a){if(!1!==b.enabled&&!0!==b.noKeys&&!0!==b.noPan)switch(a.keyCode){case b.keys.UP:b.pan(0,b.keyPanSpeed);b.update();break;case b.keys.FORWARD:b.panXZ(0,-b.keyPanSpeed);b.update();break;case b.keys.BOTTOM:b.pan(0,-b.keyPanSpeed);b.update();break;case b.keys.BACKWARD:b.panXZ(0,b.keyPanSpeed);
b.update();break;case b.keys.LEFT:b.pan(b.keyPanSpeed,0);b.update();break;case b.keys.RIGHT:b.pan(-b.keyPanSpeed,0);b.update();break;case b.keys.DOLLY_IN:if(!0===b.noZoom)break;b.dollyIn();b.update();break;case b.keys.DOLLY_OUT:if(!0===b.noZoom)break;b.dollyOut();b.update()}},!1);this.update()};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);
var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var d=document.createElement("canvas");return!(!window.WebGLRenderingContext||!d.getContext("webgl")&&!d.getContext("experimental-webgl"))}catch(g){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var d=document.createElement("div");d.id="webgl-error-message";d.style.fontFamily="monospace";d.style.fontSize="13px";d.style.fontWeight="normal";
d.style.textAlign="center";d.style.background="#fff";d.style.color="#000";d.style.padding="1.5em";d.style.width="400px";d.style.margin="5em auto 0";this.webgl||(d.innerHTML=window.WebGLRenderingContext?'Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />\nFind out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.':'Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>\nFind out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.');
return d},addGetWebGLMessage:function(d){var g,l;d=d||{};g=void 0!==d.parent?d.parent:document.body;d=void 0!==d.id?d.id:"oldie";l=Detector.getWebGLErrorMessage();l.id=d;g.appendChild(l)}};"object"===typeof module&&(module.exports=Detector);
(function(d,g,l,r){var c=function(c){this.domParent="object"===typeof c?c:g.body};c.prototype.init=function(c,b,q,da,J,B){d.requestAnimationFrame||(d.requestAnimationFrame=function(){return d.webkitRequestAnimationFrame||d.mozRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame||function(b,c){d.setTimeout(b,1E3/60)}}());this.domParent===g.body&&(this.WINDOW_WIDTH=d.innerWidth,this.WINDOW_HEIGHT=d.innerHeight,this.WINDOW_HEIGHT_HALF=this.WINDOW_HEIGHT/2,this.WINDOW_WIDTH_HALF=
this.WINDOW_WIDTH/2,d.addEventListener("resize",c,!1));this.renderType=r.webgl?"webgl":"canvas";this.renderer=q||(r.webgl?new l.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0}):new l.CanvasRenderer({preserveDrawingBuffer:!0}));this.renderer.setSize(this.WINDOW_WIDTH,this.WINDOW_HEIGHT);this.domParent.appendChild(this.renderer.domElement);this.scene=da||new l.Scene;this.camera=J||new l.PerspectiveCamera(35,this.WINDOW_WIDTH/this.WINDOW_HEIGHT,.1,1E5);this.camera.position.set(1E3,500,1E3);this.camera.lookAt(this.scene.position);
B?this.controls=B:(this.controls=new l.OrbitControls(this.camera,this.renderer.domElement,{cameraAsOrbitCenter:!0}),this.controls.target.set(0,0,0),this.controls.rotateSpeed=1,this.controls.zoomSpeed=1.2,this.controls.keyPanSpeed=10,this.controls.panSpeed=1,this.controls.noZoom=!0,this.controls.keys={LEFT:65,FORWARD:87,RIGHT:68,BACKWARD:83,UP:81,BOTTOM:69},this.controls.mouseButtons={ORBIT:l.MOUSE.MIDDLE,PAN:l.MOUSE.RIGHT});this.stats=new Stats;this.stats.domElement.style.position="absolute";this.stats.domElement.style.top=
"0px";this.stats.domElement.style.zIndex="999";g.body.appendChild(this.stats.domElement);b()};d.Base=c;"object"===typeof module&&(module.exports=c)})(window,document,THREE,Detector);
(function(){function d(d){return d.charAt(0).toUpperCase()+d.slice(1)}var g={Animation:{bubble:function(d,g){var c=$('<div class="alert alert-info alert-vp fade"></div>').appendTo(d);c.text(g);c.finish().fadeTo(200,1).delay(2500).fadeTo(100,0,function(){$(this).remove()})}}};_Container=function(){this.domElement=document.createElement("div")};_Container.prototype.createComponets=function(d){var g=0;for(d=d.length;g<d;g++);};g.map={};g.Sidebar=function(d,r){_Container.call(this);var c=this.setting=
g.Utils.settingMixin({align:"r",width:320},d),p="sidebar",p=c.align&&"r"!==c.align?p+" sidebar-left":p+" sidebar-right";this.domElement.className=p;c.id&&(this.domElement.id=c.id,g.map[c.id]=this);this.domElement.style.width=c.width.toString()+"px";c.overflow&&(this.domElement.style.overflow=c.overflow.toString());r.appendChild(this.domElement);g.Utils.domCreationDirector(c.children,this.domElement)};g.Sidebar.prototype=Object.create(_Container.prototype);g.Panel=function(d,r){_Container.call(this);
var c=this.setting=g.Utils.settingMixin({title:""},d);c.id&&(this.domElement.id=c.id,g.map[c.id]=this);var p=this.domElement;p.className="panel panel-tool";r.appendChild(p);var b=document.createElement("div");b.className="panel-heading";p.appendChild(b);var q=document.createTextNode(c.title);b.appendChild(q);b=document.createElement("div");b.className="panel-body";c.overflow&&(b.style.overflow=c.overflow.toString());p.appendChild(b);g.Utils.domCreationDirector(c.children,b)};g.Panel.prototype=Object.create(_Container.prototype);
g.Toolbar=function(d,r){_Container.call(this);var c=this.setting=g.Utils.settingMixin({title:""},d);c.id&&(this.domElement.id=c.id,g.map[c.id]=this);var p=this.domElement;p.className="btn-toolbar";r.appendChild(p);g.Utils.domCreationDirector(c.children,p)};g.Toolbar.prototype=Object.create(_Container.prototype);g.ButtonGroup=function(d,r){_Container.call(this);var c=this.setting=g.Utils.settingMixin({title:"",buttonType:"radio"},d);c.id&&(this.domElement.id=c.id,g.map[c.id]=this);var p=this.domElement;
p.className="btn-group"+(c.appendClass?" "+c.appendClass:"");"button"!==c.buttonType.toLowerCase()&&p.setAttribute("data-toggle","buttons");p.title=c.title;r.appendChild(p);var b=c.buttons;switch(c.buttonType.toLowerCase()){default:case "radio":for(var q=0,da=b.length;q<da;q++){var J=document.createElement("label");J.className="btn btn-tool"+(b[q].checked?" active":"");b[q].height&&(J.style.height=b[q].height+"px");b[q].width&&(J.style.width=b[q].width+"px");if(b[q].bgType&&b[q].bgTypeData){var B;
switch(b[q].bgType){case "color":B=b[q].bgTypeData;J.className+=" btn-color";break;case "image":B="url("+b[q].bgTypeData+") no-repeat 50% 50%";J.className+=" btn-image";break;default:return}J.style.background=B}p.appendChild(J);var K=document.createElement("input");b[q].checked&&K.setAttribute("checked","");K.type=c.buttonType;K.name=c.name;K.id=b[q].id;K.value=q;K.autocomplete="off";J.appendChild(K);B=document.createTextNode(b[q].title);J.appendChild(B)}break;case "button":for(q=0,da=b.length;q<
da;q++){K=document.createElement("button");K.className="btn btn-tool";K.id=b[q].id;K.name=c.name;b[q].height&&(K.style.height=b[q].height+"px");b[q].width&&(K.style.width=b[q].width+"px");if(b[q].bgType&&b[q].bgTypeData){switch(b[q].bgType){case "color":B=b[q].bgTypeData;J.className+=" btn-color";break;case "image":B="url("+b[q].bgTypeData+") no-repeat 50% 50%";J.className+=" btn-image";break;default:return}K.style.background=B}p.appendChild(K);B=document.createTextNode(b[q].title);K.appendChild(B)}}g.Utils.domCreationDirector(c.children,
this.domElement)};g.ButtonGroup.prototype=Object.create(_Container.prototype);g.ButtonGroup.prototype.addButton=function(d,g){g||this.setting.buttons.push(d);var c=document.createElement("label");c.className="btn btn-tool"+(d.checked?" active":"");d.height&&(c.style.height=d.height+"px");d.width&&(c.style.width=d.width+"px");if(d.bgType&&d.bgTypeData){var p;switch(d.bgType){case "color":p=d.bgTypeData;c.className+=" btn-color";break;case "image":p="url("+d.bgTypeData+") no-repeat 50% 50%";c.className+=
" btn-image";break;default:return}c.style.background=p}this.domElement.appendChild(c);p=document.createElement("input");d.checked&&p.setAttribute("checked","");p.type=this.setting.buttonType;p.name=this.setting.name;p.id=d.id;p.value=this.setting.buttons.length-1;p.autocomplete="off";c.appendChild(p);p=document.createTextNode(d.title);c.appendChild(p);return c};g.ButtonGroup.prototype.addButtons=function(d,g){for(var c=0,p=d.length;c<p;c++)this.addButton(d[c],g)};g.Utils={};g.Utils.settingMixin=function(d,
g){if("object"===typeof d&&"object"===typeof g){var c={},p;for(p in d)c[p]=d[p];for(var b in g)void 0!==g[b]&&(c[b]=g[b]);return c}return d};g.Utils.domCreationDirector=function(l,r){if(l)if(l instanceof Array)for(var c=0,p=l.length;c<p;c++)g.Utils.domCreationDirector(l[c],r?r:document.body);else l instanceof Object&&l.UIType&&g[d(l.UIType)]&&new (g[d(l.UIType)])(l,r?r:document.body)};window.GoUI=g;"object"===typeof module&&(module.exports=g)})();
var vertexShader="varying vec3 vWorldPosition;void main() {   vec4 worldPosition = modelMatrix * vec4( position, 1.0 );   vWorldPosition = worldPosition.xyz;    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );}",fragmentShader="uniform vec3 topColor;uniform vec3 bottomColor;uniform float offset;uniform float exponent;varying vec3 vWorldPosition;void main() {float h = normalize( vWorldPosition + offset ).y;gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h, 0.0 ), exponent ), 0.0 ) ), 1.0 );}";
AV.initialize("i5m1bad33f8bm725g0lan5wd8hhc1c4qhyz3cyq4b0qoyvja","2w44ugxt0z512vitlk5in4c4a95acbyj8qiqlgcuh3p9xm5t");
(function(d,g,l,r,c){var p,b;function q(m){var a=k.textures+(m?-1:1),a=g.getElementById("texture"+a);if(!a&&(a=m?ra.length-1:0,a=g.getElementById("texture"+a),!a))return;m=a.parentElement.className.indexOf("btn-color");var c=a.parentElement.className.indexOf("btn-image");-1<m?(p=Number(a.value),g.getElementById("colorTexture").parentElement.click()):-1<c&&(b=Number(a.value),g.getElementById("imageTexture").parentElement.click())}function da(a,b){var c=b.clone(),d;for(d in a)c[d]=a[d];return c}function J(a){if(null==
a.pageX&&null!=a.clientX){var b=g.documentElement,c=g.body;a.pageX=a.clientX+(b&&b.scrollLeft||c&&c.scrollLeft||0)-(b&&b.clientLeft||c&&c.clientLeft||0);a.pageY=a.clientY+(b&&b.scrollTop||c&&c.scrollTop||0)-(b&&b.clientTop||c&&c.clientTop||0)}ia.set(a.pageX/h.WINDOW_WIDTH*2-1,2*-(a.pageY/h.WINDOW_HEIGHT)+1);la.setFromCamera(ia,h.camera);return la.intersectObjects(V)}function B(a,b){b&&a&&(a.position.copy(b.point).add(b.face.normal),a.position.divideScalar(s.width).floor().multiplyScalar(s.width).addScalar(s.width/
2))}function K(a){0<a.length&&B(E,a[0])}function X(a,b){a&&a.then(function(a){$("#openModal .modal-body #myBox").html("");for(var b=0,m=a.length;b<m;b++)$("#openModal .modal-body #myBox").append('<label class="btn btn-primary">  <input type="radio" name="boxData" id="boxData'+b+'" value="'+a[b].id+'" autocomplete="off">  <label id="boxDataLabel'+b+'"></label></label>'),$("#openModal .modal-body .button-group #boxDataLabel"+b).text(a[b].get("name"));$("#openModal").modal("show")});b&&b.then(function(a){$("#openModal .modal-body #myKeep").html("");
for(var b=0,m=a.length;b<m;b++)$("#openModal .modal-body #myKeep").append('<label class="btn btn-primary">  <input type="radio" name="boxData" id="boxData'+b+'" value="'+a[b].get("box").id+'" autocomplete="off">  <label id="boxDataLabel'+b+'"></label></label>'),$("#openModal .modal-body .button-group #boxDataLabel"+b).text(a[b].get("box").get("name"));$("#openModal").modal("show")})}function L(a,b,c,d){a=a||J(event);if(0<a.length){a=a[0];var e=k.toolsType,f=!1,g=V.length;if(g&&a.object!==ja)for(var l=
g-1;0<l&&l>g-1-3;l--)if(a.object===V[l]){f=!0;break}0===e?!0===f&&!1===b||!1===f&&!0===b||(b=ca.draw(0,va,void 0,a),d?S.appendObjectToCurrentAction("draw",b):S.addAction("draw",b),h.renderer.render(h.scene,h.camera)):1===e&&c&&a.object!==ja&&(b=ca.erase(a.object),d?S.appendObjectToCurrentAction("erase",b):S.addAction("erase",b))}}function x(){AV.User.current()&&a&&a.get("user")&&AV.User.current().id!==a.get("user").id||(e.save(e.storageKeys.localChanges,S.changed),e.save(e.storageKeys.camera),e.save(e.storageKeys.sidebar),
e.save())}function qa(b){0!==A||AV.User.current()&&a&&a.get("user")&&AV.User.current().id!==a.get("user").id||("0"===S.changed||1>R.length&&(!a||a&&!a.id)||!AV.User.current?(e.save(e.storageKeys.camera),e.save(e.storageKeys.sidebar),e.save()):confirm("\u662f\u5426\u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\uff1f")&&k.save())}function Y(b){A=1;AV.User.current()&&a&&a.get("user")&&AV.User.current().id!==a.get("user").id||("0"===S.changed||1>R.length&&(!a||a&&!a.id)?(e.save(e.storageKeys.localChanges,S.changed),
e.save(e.storageKeys.camera),e.save(e.storageKeys.sidebar),e.save()):confirm("\u662f\u5426\u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\uff1f")&&k.save())}function sa(a){a.preventDefault();var b;if(1===na[0])try{1===ma?ma=0:(ma=1,b=J(a),L(b,a.ctrlKey,a.ctrlKey,!0))}catch(c){console.warn("draw/erase failed")}finally{ma=0}else b=k.toolsType,1===b?E.visible&&(E.visible=!1):(!E.visible&&f&&(E.visible=!0),b=J(a),K(b))}function Z(a){a.preventDefault();switch(a.button){case 0:if(!y.endFlag){y.instantComplete(y.loadBoxAnimation);
break}na[0]=1;a=J(a);L(a,void 0,!0,!1);0===k.toolsType&&K(a);break;case 1:na[1]=1;break;case 2:na[2]=1}}function ha(a){if("label"===this.nodeName.toLowerCase())switch(a=this.getElementsByTagName("input")[0],k[a.name]=Number(a.value),a.name){case "toolsType":1===Number(a.value)?E.visible&&(E.visible=!1):!E.visible&&f&&(E.visible=!0);break;case "textures":va=k[a.name];v=ra[va];ya=v.data;za=v.helperData=ra[k[a.name]].helperData||da(wa,ya);E.material=za;g.getElementById("cube").parentElement.click();
switch(k.texturesType){case 0:b=a.value;break;default:case 1:p=a.value}break;case "sidebarResize":var c=GoUI.map.sidebar.domElement;"0"===a.value?$(c).animate({top:"0",height:"100%"}):$(c).animate({top:"60%",height:"40%"});break;case "texturesType":a=a.id,"imageTexture"===a?($(".btn-color").hide(),$(".btn-image").show(),g.getElementById("texture"+b).parentElement.click()):"colorTexture"===a&&($(".btn-color").show(),$(".btn-image").hide(),g.getElementById("texture"+p).parentElement.click())}else if(("button"===
this.type||"button"===this.nodeName.toLowerCase())&&k[this.id])k[this.id]()}function ga(a){switch(a.button){case 0:na[0]=0;S.isCurrentActionAlive=!1;break;case 1:na[1]=0;break;case 2:na[2]=0}}function O(a){switch(a.keyCode){case 67:q();break;case 88:q(!0)}}function ba(a){if(!na[0])switch(a.keyCode){case 16:0===k.toolsType?g.getElementById("eraser").parentElement.click():1===k.toolsType&&g.getElementById("cube").parentElement.click();break;case 90:a.ctrlKey&&S.undo();break;case 89:a.ctrlKey&&S.redo()}}
function ka(){requestAnimationFrame(ka);h.renderer.render(h.scene,h.camera);h.stats.update()}function z(){g.getElementById("openIt").removeEventListener("click",z,!1);"0"===S.changed||1>R.length&&(!a||a&&!a.id)||confirm("\u662f\u5426\u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\uff1f")&&k.save();var b=$("#openModal input[type=radio]:checked").val();b&&(new AV.Query(w)).get(b,{success:function(b){k.clearAll();S=new N;S.updateDom();a=b;e.loadCamera(b.get("camera"),!0);e.loadMeshes(b.get("meshes"),M,y.loadBoxAnimation,
!0);b.get("user").id===AV.User.current().id&&(e.save(e.storageKeys.localChanges,"0"),e.save(e.storageKeys.boxName,a.get("name")),e.save(e.storageKeys.boxId,a.id),e.save(e.storageKeys.updatedAt,a.updatedAt),e.save(e.storageKeys.camera),e.save(e.storageKeys.sidebar),e.save())}});$("#openModal").modal("hide")}function n(){g.getElementById("openIt").removeEventListener("click",n,!1);var a=$("#openModal input[type=radio]:checked").val();if(a){var b=new AV.Query(w);b.equalTo("objectId",a);b.select("shared");
b.first().then(function(b){if(!b.get("shared")){var c=new AV.ACL(AV.User.current());c.setPublicReadAccess(!0);b.setACL(c);b.set("shared",!0);b.save().then(function(){},function(){U("\u5206\u4eab\u5931\u8d25")})}$("#shareLink").val("http://gonster.github.io/helloThreeJS/voxel-paint#"+a);U("\u5206\u4eab\u6210\u529f\uff0c\u53ef\u901a\u8fc7\u663e\u793a\u7684\u94fe\u63a5\u6253\u5f00\u5206\u4eab\u5185\u5bb9")})}}function aa(a){a?($("#loginOpener").hide(),$("#logout").show(),$("#signInOpener").hide(),$("#loginMessage").html("\u4f60\u597d "+
AV.User.current().escape("username")),$("#loginMessage").show(),$("#open").removeAttr("disabled"),$("#newFile").removeAttr("disabled"),$("#share").removeAttr("disabled"),$("#delete").removeAttr("disabled"),$("#insert").removeAttr("disabled")):($("#loginOpener").show(),$("#logout").hide(),$("#signInOpener").show(),$("#loginMessage").hide(),$("#open").attr("disabled","disabled"),$("#newFile").attr("disabled","disabled"),$("#share").attr("disabled","disabled"),$("#delete").attr("disabled","disabled"),
$("#insert").attr("disabled","disabled"))}function U(b){GoUI.Animation.bubble($("#bubble"),b);b=a.name||"\u672a\u547d\u540d";var c=("0"===S.changed?"\u672a\u4fee\u6539":"\u5df2\u4fee\u6539")+(a.id?" - \u4e91\u7aef\u5b58\u50a8":" - \u672c\u5730\u5b58\u50a8");$("#currentFileName").text("\u6587\u4ef6\u540d\uff1a"+b);$("#currentFileState").text("\u6587\u4ef6\u72b6\u6001\uff1a"+c)}var oa=!1,ea=g.createElement("a");ea.id="imageCapture";ea.style.display="none";ea.target="_blank";g.body.appendChild(ea);var w=
AV.Object.extend("Box"),a=new w,D=AV.Object.extend("Keep");new D;c=function(a){this.endFlag=a;this.currentAnimationIntervalHandler=-1;this.currentMeshes=[];this.currentIterator=0};c.prototype={asyncLoadDefaultInterval:1,loadBoxAnimation:function(){var a=y.currentMeshes;y.currentIterator<a.length?a[y.currentIterator].meshObject.visible=!0:(y.endFlag=!0,clearInterval(y.currentAnimationIntervalHandler));y.currentIterator++},begin:function(a,b,c){this.endFlag=!1;this.currentMeshes=b;this.currentIterator=
0;this.currentAnimationIntervalHandler=setInterval(a,c||this.asyncLoadDefaultInterval)},instantComplete:function(a){if(!0!==this.endFlag){var b=y.currentMeshes;for(clearInterval(this.currentAnimationIntervalHandler);this.currentIterator<b.length;)a();this.endFlag=!0}}};var G=function(a){this.isLoadingBoxEnd=a};G.prototype={LOAD_TYPE:{async:0,sync:1},storageKeys:{meshes:"vp_meshs",camera:"vp_camera",sidebar:"vp_sidebar",boxId:"vp_box_id",updatedAt:"vp_updatedAt",boxName:"vp_box_name",localChanges:"vp_local_changes"},
load:function(a){return d.localStorage&&d.localStorage.getItem(a||this.storageKeys.meshes)},save:function(a,c){if(d.localStorage){var e="";if(c)e=c;else switch(a){default:case this.storageKeys.meshes:case void 0:if(!this.isLoadingBoxEnd&&0>S.currentActionIndex)return;for(var e=e+(s.width+":"),f=0,g=R.length;f<g;f++)e+=R[f].geo.id.replace("geo","")+",",e+=R[f].material.id.replace("texture","")+",",e+=R[f].meshObject.position.x+",",e+=R[f].meshObject.position.y+",",e+=R[f].meshObject.position.z+";";
break;case this.storageKeys.camera:e+=h.controls.target.x+","+h.controls.target.y+","+h.controls.target.z+";";e+=h.controls.object.position.x+","+h.controls.object.position.y+","+h.controls.object.position.z+";";break;case this.storageKeys.sidebar:e+=b+","+p+","+k.texturesType+","+k.sidebarResize}d.localStorage.setItem(a||this.storageKeys.meshes,e)}},loadMeshes:function(a,b,c,e){this.isLoadingBoxEnd=!1;var d=[],f=s.width;if(a=e?a:this.load(a))if(a=a.split(":"))2===a.length?(f=(Number(a[0])||50)/s.width,
d=a[1].split(";")):(f=50/s.width,d=a[0].split(";"));if(0<d.length)switch(b){case this.LOAD_TYPE.sync:b=0;for(a=d.length;b<a;b++){var g=d[b].split(",");2<g.length&&ca.draw(Number(g[0]),Number(g[1]),[Number(g[2])/f,Number(g[3])/f,Number(g[4])/f])}this.isLoadingBoxEnd=!0;break;default:case this.LOAD_TYPE.async:b=0;for(a=d.length;b<a;b++)g=d[b].split(","),2<g.length&&ca.draw(Number(g[0]),Number(g[1]),[Number(g[2])/f,Number(g[3])/f,Number(g[4])/f],void 0,void 0,!0);y.begin(c,R);e?U("\u8f7d\u5165\u5b8c\u6210\uff0c\u5de6\u952e\u5355\u51fb\u53ef\u7acb\u5373\u5b8c\u6210\u52a8\u753b"):
U("\u8f7d\u5165\u672c\u5730\u6570\u636e\u5b8c\u6210\uff0c\u5de6\u952e\u5355\u51fb\u53ef\u7acb\u5373\u5b8c\u6210\u52a8\u753b")}else U("\u65e0\u672c\u5730\u6570\u636e\uff0c\u65b0\u5efa\u6587\u4ef6"),y.endFlag=!0},loadRemote:function(){if(d.localStorage){var b=this.load(this.storageKeys.boxId),c=this.load(this.storageKeys.updatedAt);if(b){U("\u8f7d\u5165\u4e91\u7aef\u6587\u4ef6...");var f=new AV.Query(w);f.select("name","user");f.equalTo("objectId",b);f.first({success:function(b){if(b.updatedAt===c)a=
b,b.set("meshes",e.load(e.storageKeys.meshes)),b.set("camera",e.load(G.storageKeys.camera)),e.loadCamera(a.get("camera"),!0),e.loadMeshes(a.get("meshes"),M,y.loadBoxAnimation,!0),e.save(e.storageKeys.boxName,a.get("name")),S.changed=e.load(e.storageKeys.localChanges);else if(a=b,b.get("user").id===AV.User.current().id)if("0"===(S.changed=e.load(e.storageKeys.localChanges))){var m=new AV.Query(w);m.get(b.id,{success:function(b){a=b;e.loadCamera(a.get("camera"),!0);e.loadMeshes(a.get("meshes"),M,y.loadBoxAnimation,
!0);e.save(e.storageKeys.boxName,a.get("name"));e.save(e.storageKeys.updatedAt,a.updatedAt);e.save(e.storageKeys.camera);e.save()},error:function(a,c){b.set("meshes",e.load(e.storageKeys.meshes));b.set("camera",e.load(G.storageKeys.camera));e.loadMeshes(void 0,M,y.loadBoxAnimation)}})}else U("\u7531\u4e8e\u672c\u5730\u6b64\u6587\u4ef6\u4e0e\u4e91\u7aef\u6587\u4ef6\u5728\u540c\u4e00\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u505a\u4e86\u4e0d\u540c\u7684\u6539\u52a8\uff0c\u5c06\u672c\u5730\u7248\u672c\u4e0e\u4e91\u7aef\u6b64\u6587\u4ef6\u89c6\u4e3a\u4e0d\u540c\u7684\u6587\u4ef6"),
a=new w,e.save(e.storageKeys.boxId,""),e.save(e.storageKeys.updatedAt,""),e.save(e.storageKeys.boxName,""),e.save(e.storageKeys.localChanges,"1"),this.changed=1,e.loadMeshes(void 0,M,y.loadBoxAnimation);else m=new AV.Query(w),m.get(b.id,{success:function(b){a=b;e.loadCamera(a.get("camera"),!0);e.loadMeshes(a.get("meshes"),M,y.loadBoxAnimation,!0)},error:function(a,b){e.loadMeshes(void 0,M,y.loadBoxAnimation)}})},error:function(a,b){U("\u8f7d\u5165\u5931\u8d25\uff0c"+b.message);e.loadMeshes(void 0,
M,y.loadBoxAnimation)}})}else e.loadMeshes(void 0,M,y.loadBoxAnimation)}},loadShared:function(b,c){(new AV.Query(w)).get(b,{success:function(b){a=b;e.loadCamera(a.get("camera"),!0);e.loadMeshes(a.get("meshes"),M,y.loadBoxAnimation,!0);U("\u5df2\u8f7d\u5165\u5206\u4eab\u6587\u4ef6")},error:function(a,b){c()}})},loadCamera:function(a,b){var c=[],e=b?a:this.load(a);e&&(c=e.split(";"));if(0<c.length){for(var e=0,d=c.length;e<d;e++){var f=c[e].split(",");switch(e){case 0:h.controls.target.set(Number(f[0])||
0,Number(f[1])||0,Number(f[2])||0);break;case 1:h.controls.object.position.set(Number(f[0])||0,Number(f[1])||0,Number(f[2])||0)}}h.controls.update()}},loadSidebarSelectedButtons:function(a,c){var e=[],d=c?a:this.load(a);d&&(e=d.split(","));if(0<e.length)for(var d=0,f=e.length;d<f;d++){var h=e[d];if(""!==h&&!isNaN(Number(h)))switch(d){case 0:b=Number(h)||0;break;case 1:p=Number(h)||0;break;case 2:1===Number(h)?g.getElementById("colorTexture").parentElement.click():g.getElementById("imageTexture").parentElement.click();
break;case 3:1===Number(h)?g.getElementById("minSidebar").parentElement.click():g.getElementById("normalSidebar").parentElement.click()}}else g.getElementById("imageTexture").parentElement.click()}};var N=function(){this.currentActionIndex=-1;this.actionArray=[];this.isCurrentActionAlive=void 0;this.changed="0"};N.prototype={undo:function(){var a;if(!(0>this.currentActionIndex)){a=this.actionArray[this.currentActionIndex];var b=ca.reverseOperationMap[a.type];a=a.meshes;a instanceof Array||(a=[a]);
for(var c=0,e=a.length;c<e;c++){var d=a[c];if(d)switch(b){case "draw":ca.draw(d.geo,d.material,[d.meshObject.position.x,d.meshObject.position.y,d.meshObject.position.z],void 0,d.meshObject);break;case "erase":ca.erase(d.meshObject)}}this.currentActionIndex--;this.updateDom()}},redo:function(){var a;if(!(this.currentActionIndex>=this.actionArray.length-1)){a=this.actionArray[this.currentActionIndex+1];var b=a.type;a=a.meshes;a instanceof Array||(a=[a]);for(var c=0,d=a.length;c<d;c++){var e=a[c];if(e)switch(b){case "draw":ca.draw(e.geo,
e.material,[e.meshObject.position.x,e.meshObject.position.y,e.meshObject.position.z],void 0,e.meshObject);break;case "erase":ca.erase(e.meshObject)}}this.currentActionIndex++;this.updateDom()}},addAction:function(b,c){this.actionArray.length=-1<this.currentActionIndex+1?this.currentActionIndex+1:0;this.isCurrentActionAlive=!0;this.actionArray.push({type:b,meshes:c});this.currentActionIndex++;this.updateDom();if(AV.User.current()&&a&&a.get("user")&&AV.User.current().id!==a.get("user").id)if(confirm("\u786e\u5b9a\u8981\u4fee\u6539\u5417\uff1f\uff08\u5c06\u4f1a\u4f5c\u4e3a\u65b0\u5efa\u7684\u6587\u4ef6\u8986\u76d6\u672c\u5730\u4fdd\u5b58\u7684\u6570\u636e\uff09"))a=
new w,e.save(e.storageKeys.boxId,""),e.save(e.storageKeys.updatedAt,""),e.save(e.storageKeys.boxName,""),e.save(e.storageKeys.localChanges,"1");else{this.undo();return}this.changed=1},appendObjectToCurrentAction:function(a,b){var c=this.actionArray[this.currentActionIndex];if(!0!==this.isCurrentActionAlive)this.addAction(a,b);else if(void 0===c.meshes)c.meshes=b;else if(c.meshes instanceof Array||(c.meshes=[c.meshes]),b instanceof Array)for(var e=0,d=b.length;e<d;e++)c.meshes.push(b[e]);else c.meshes.push(b)},
updateDom:function(){g.getElementById("undo").disabled=0>this.currentActionIndex?!0:!1;g.getElementById("redo").disabled=this.currentActionIndex>=this.actionArray.length-1?!0:!1}};var C=function(){this.drawFlag=!1};C.prototype={calculateIntersectResult:J,setMeshPositionToFitTheGrid:B,updateHelperCube:K,draw:function(a,b,c,e,d,f){if(void 0===a||"number"===typeof a)a=xa[a||0];if(void 0===b||"number"===typeof b)b=ra[b||0];var g=a.data,k=b.data;d=d||new r.Mesh(g,k);d.castShadow=!0;d.receiveShadow=!0;
e?B(d,e):d.position.set(c[0],c[1],c[2]);!f||(d.visible=!1);h.scene.add(d);V.push(d);R.push({meshObject:d,geo:a,material:b});return R[R.length-1]},erase:function(a){h.scene.remove(a);a=V.indexOf(a);if(!(0>a)){V.splice(a,1);var b=R[a-1];R.splice(a-1,1);return b}},reverseOperationMap:{draw:"erase",erase:"draw"}};r.ImageUtils.crossOrigin="Anonymous";var h,s={width:50},H=s.width/50,fa={webgl:{ambientLightColor:3158064,directionalLightDensity:.8,basePlaneSegments:2,basePlaneWidth:5E4*H,basePlaneTextureRepeat:80,
fogNear:8E3*H,fogFar:25E3*H,sphereRadius:25E3*H},canvas:{ambientLightColor:9474192,directionalLightDensity:1,basePlaneSegments:32,basePlaneWidth:6E3*H,basePlaneTextureRepeat:16,fogNear:2E3*H,fogFar:3E3*H,sphereRadius:3E3*H}},ua,ja,ta,A=0,M=G.prototype.LOAD_TYPE.async,t=new r.MeshLambertMaterial({color:592137}),wa={opacity:.5,transparent:!0},ra=[{name:"default",type:"color",uniqueData:"#090909",id:"texture0",data:t,helperData:da(wa,t)}],xa=[{name:"default",type:"1",id:"geo0",data:new r.BoxGeometry(s.width,
s.width,s.width,1,1,1)}];b=30;p=0;var f=!0,k={toolsType:0,toolsRadius:0,textures:0,texturesType:0,toggleAux:function(){1===k.toolsType||(E.visible=!E.visible);f=!f},capture:function(){var a=h.renderer.domElement,b=-1;if(-1!=navigator.appName.indexOf("Internet Explorer")||-1!=navigator.userAgent.toLowerCase().indexOf("trident")){var c=navigator.userAgent,e=/MSIE ([0-9]{1,}[.0-9]{0,})/;null!=e.exec(c)?b=parseFloat(RegExp.$1):(e=/rv:([0-9]{1,}[.0-9]{0,})/,null!=e.exec(c)&&(b=parseFloat(RegExp.$1)))}-1!==
b?(d.navigator.saveBlob=d.navigator.saveBlob||d.navigator.msSaveBlob,a.msToBlob&&d.navigator.saveBlob?d.navigator.saveBlob(a.msToBlob(),"capture.png"):alert("failed to save image, please use other tools to capture it.")):(ea.href=a.toDataURL(),ea.download="capture.png",ea.click())},clearAll:function(){y.endFlag||y.instantComplete(y.loadBoxAnimation);if(!(1>R.length)){var a=ca.erase(R[0].meshObject);S.addAction("erase",a);for(var b=0,c=R.length;b<c;b++)a=ca.erase(R[0].meshObject),S.appendObjectToCurrentAction("erase",
a)}},undo:function(){S.undo()},redo:function(){S.redo()},signInOpener:function(){$("#signInEmail").val("");$("#signInUsername").val("");$("#signInPassword").val("");$("#signInError").parent().hide();$("#signInModal").modal("show");$("#signInEmail").focus()},loginOpener:function(){$("#loginUsername").val("");$("#loginPassword").val("");$("#loginError").parent().hide();$("#loginModal").modal("show");$("#loginUsername").focus()},logout:function(){AV.User.current()&&AV.User.logOut();aa(!1);U("\u5df2\u767b\u51fa")},
save:function(){if(AV.User.current()){if("0"!==S.changed||a.id){var b;b=""+(s.width+":");for(var c=0,d=R.length;c<d;c++)b+=R[c].geo.id.replace("geo","")+",",b+=R[c].material.id.replace("texture","")+",",b+=R[c].meshObject.position.x+",",b+=R[c].meshObject.position.y+",",b+=R[c].meshObject.position.z+";";c=""+(h.controls.target.x+","+h.controls.target.y+","+h.controls.target.z+";");c+=h.controls.object.position.x+","+h.controls.object.position.y+","+h.controls.object.position.z+";";a.set("camera",
c||"0,0,0;1000,500,1000");a.set("meshes",b||"");a.id||(b=prompt("\u8bf7\u8f93\u5165\u6587\u4ef6\u540d",a.get("name")||e.load(e.storageKeys.boxName)||"\u672a\u547d\u540d"),a.set("name",b||"\u672a\u547d\u540d"),a.set("user",AV.User.current()),a.set("ACL",new AV.ACL(AV.User.current())));a.save({success:function(a){U("\u5df2\u4fdd\u5b58\u81f3\u4e91\u7aef");e.save(e.storageKeys.updatedAt,a.updatedAt);e.save(e.storageKeys.boxId,a.id);e.save(e.storageKeys.boxName,a.get("name"))},error:function(a,b){U("\u4e91\u7aef\u4fdd\u5b58\u5931\u8d25\uff0c\u5c06\u4f1a\u4fdd\u5b58\u5728\u672c\u5730"+
b.message);e.save(e.storageKeys.boxName,a.get("name"));S.changed="1";e.save(e.storageKeys.localChanges,"1")}})}else U("\u6587\u4ef6\u672a\u505a\u4efb\u4f55\u4fee\u6539\uff0c\u5c06\u672c\u5730\u4fdd\u5b58");S.changed="0";e.save(e.storageKeys.localChanges,"0");e.save(e.storageKeys.camera);e.save(e.storageKeys.sidebar);e.save()}else e.save(e.storageKeys.camera),e.save(e.storageKeys.sidebar),e.save(),b="\u5df2\u4fdd\u5b58\u5728\u672c\u5730",oa||(b+="\uff0c\u767b\u5f55\u540e\u53ef\u5411\u4e91\u7aef\u4fdd\u5b58\u591a\u4e2a\u6587\u4ef6",
oa=!0),U(b)},newFile:function(){"0"===S.changed||1>R.length&&(!a||a&&!a.id)||confirm("\u662f\u5426\u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\uff1f")&&k.save();k.clearAll();S=new N;S.updateDom();a=new w;e.save(e.storageKeys.localChanges,"0");e.save(e.storageKeys.camera);e.save(e.storageKeys.sidebar);e.save(e.storageKeys.updatedAt,"");e.save(e.storageKeys.boxName,"");e.save()},open:function(){g.getElementById("openIt").addEventListener("click",z,!1);var a=new AV.Query(w);a.select("name");a.equalTo("user",
AV.User.current());var b=new AV.Query(D);b.select("name","box");b.equalTo("user",AV.User.current());X(a.find(),b.find());$("#openModal .modal-body #boxTitle").text("\u6211\u7684\u6587\u4ef6");$("#openModal .modal-body #keepTitle").text("\u6211\u7684\u6536\u85cf")},share:function(){g.getElementById("openIt").addEventListener("click",n,!1);var a=new AV.Query(w);a.select("name");a.equalTo("user",AV.User.current());X(a.find());$("#openModal .modal-body #boxTitle").text("\u6211\u7684\u6587\u4ef6");$("#openModal .modal-body #keepTitle").html('\u5206\u4eab\u94fe\u63a5\uff1a<input type="text" id="shareLink">')}},
va=0,v=ra[0],ya=v.data,za=v.helperData,Aa=xa[0].data,E,V=[],R=[],Ba,W,Ca,ia,na=[0,0,0],la,I,y=new c,e=new G(!1),S=new N,ca=new C,ma=0;h=new l(g.body);h.init(function(a){if(h.WINDOW_WIDTH!==d.innerWidth||h.WINDOW_HEIGHT!==d.innerHeight)h.WINDOW_WIDTH=d.innerWidth,h.WINDOW_HEIGHT=d.innerHeight,h.WINDOW_HEIGHT_HALF=h.WINDOW_HEIGHT/2,h.WINDOW_WIDTH_HALF=h.WINDOW_WIDTH/2,h.camera.aspect=h.WINDOW_WIDTH/h.WINDOW_HEIGHT,h.camera.updateProjectionMatrix(),h.renderer.setSize(h.WINDOW_WIDTH,h.WINDOW_HEIGHT),
g.body.height=h.WINDOW_HEIGHT},function(){ua=new r.PlaneBufferGeometry(fa[h.renderType].basePlaneWidth,fa[h.renderType].basePlaneWidth,fa[h.renderType].basePlaneSegments,fa[h.renderType].basePlaneSegments);ua.applyMatrix((new r.Matrix4).makeRotationX(-Math.PI/2));var a=r.ImageUtils.loadTexture("texture/grasslight-big.jpg"),b=r.ImageUtils.loadTexture("texture/sky.jpg");a.wrapT=a.wrapS=r.RepeatWrapping;a.repeat.set(fa[h.renderType].basePlaneTextureRepeat,fa[h.renderType].basePlaneTextureRepeat);ta=
new r.MeshPhongMaterial({ambient:16777215,color:3394611,map:a,bumpMap:a,bumpScale:3,specular:3364147,shininess:15,emissive:16777215});ja=new r.Mesh(ua,ta);ja.receiveShadow=!0;ja.material.side=r.DoubleSide;h.scene.add(ja);V.push(ja);Ba=new r.AmbientLight(fa[h.renderType].ambientLightColor);h.scene.add(Ba);W=new r.DirectionalLight(15658734,fa[h.renderType].directionalLightDensity);W.position.set(0,6E3,5E3);W.target.position.set(0,0,0);W.castShadow=!0;W.shadowCameraNear=h.camera.near;W.shadowCameraFar=
h.camera.far;W.shadowCameraFov=h.cam;W.shadowCameraTop=-1024*H;W.shadowCameraLeft=-1024*H;W.shadowCameraBottom=1024*H;W.shadowCameraRight=1024*H;W.shadowBias=2E-5;W.shadowDarkness=.4;W.shadowMapWidth=2048*H;W.shadowMapHeight=2048*H;h.scene.add(W);Ca=new r.HemisphereLight(16777215,6316128,1);h.scene.add(Ca);a=new r.SphereGeometry(fa[h.renderType].sphereRadius,32,15,0,2*Math.PI,0,Math.PI/2);b=new r.MeshLambertMaterial({color:3368703,map:b,side:r.BackSide,emissive:16777215});b=new r.Mesh(a,b);h.scene.add(b);
E=new r.Mesh(Aa,za);E.position.set(s.width/2,s.width/2,s.width/2);h.scene.add(E);new r.Mesh(Aa,ya);la=new r.Raycaster;ia=new r.Vector2;I=new r.FogExp2(16777215,5.3E-5);h.scene.fog=I;h.controls.settings.boxScale=H;h.renderer.setClearColor(15790320);h.renderer.shadowMapEnabled=!0;h.renderer.shadowMapType=r.PCFSoftShadowMap;h.renderer.shadowMapCullFace=r.CullFaceBack;h.renderer.gammaInput=!0;h.renderer.gammaOutput=!0;d.addEventListener("unload",qa,!1);d.addEventListener("reload",Y,!1);h.renderer.domElement.addEventListener("mousemove",
sa,!1);h.renderer.domElement.addEventListener("mousedown",Z,!1);h.renderer.domElement.addEventListener("mouseup",ga,!1);g.addEventListener("keydown",O,!1);g.addEventListener("keyup",ba,!1);setInterval(x,12E4)});ka();C={UIType:"sidebar",id:"sidebar",children:[{UIType:"buttonGroup",id:"sidebarResize",name:"sidebarResize",buttons:[{title:" + ",id:"normalSidebar",checked:!0},{title:" -",id:"minSidebar"}]},{UIType:"buttonGroup",id:"accountControl",name:"accountControl",buttonType:"button",appendClass:"btn-group-accountbtn",
buttons:[{title:"\u6ce8\u518c",id:"signInOpener"},{title:"\u767b\u5f55",id:"loginOpener"},{title:"\u767b\u51fa",id:"logout"},{title:"\u767b\u5f55\u540e\u65b9\u53ef\u4fdd\u5b58\u6570\u636e\u5230\u4e91\u7aef",id:"loginMessage"}]},{UIType:"panel",title:"\u753b\u7b14",name:"tools",id:"panel1",children:[{UIType:"Toolbar",id:"toolbar0",children:[{UIType:"buttonGroup",title:"\u753b\u7b14\u7c7b\u578b(shift\u5207\u6362 \u6309\u4f4fctrl\u65b9\u5757\u5806\u53e0\u6216\u8fde\u7eed\u64e6\u9664)",id:"buttonGroup0",
name:"toolsType",buttons:[{title:"\u65b9\u5757",id:"cube",checked:!0},{title:"\u64e6\u9664",id:"eraser"}]}]}]},{UIType:"panel",title:"\u6587\u4ef6",name:"files",id:"panelFiles",children:[{UIType:"buttonGroup",id:"currentFileNameGroup",name:"cfn",buttonType:"button",appendClass:"btn-group-cfnbtn",buttons:[{title:"",id:"currentFileName"}]},{UIType:"buttonGroup",id:"currentFileStateGroup",name:"cfs",buttonType:"button",appendClass:"btn-group-cfsbtn",buttons:[{title:"",id:"currentFileState"}]},{UIType:"buttonGroup",
id:"buttonGroupADM",name:"adm",buttonType:"button",appendClass:"btn-group-toolbtn",buttons:[{title:"\u65b0\u5efa",id:"newFile"},{title:"\u4fdd\u5b58",id:"save"},{title:"\u6536\u85cf",id:"keep"},{title:"\u6253\u5f00...",id:"open"},{title:"\u63d2\u5165...",id:"insert"},{title:"\u5220\u9664...",id:"delete"},{title:"\u5171\u4eab...",id:"share"}]}]},{UIType:"panel",title:"\u5176\u4ed6\u529f\u80fd",name:"tools",id:"panel3",children:[{UIType:"buttonGroup",title:"",id:"buttonGroup3",name:"aux",buttonType:"button",
appendClass:"btn-group-toolbtn",buttons:[{title:"\u8f85\u52a9\u7269\u4f53\u5f00\u5173",id:"toggleAux"},{title:"\u622a\u56fe",id:"capture"},{title:"\u6e05\u7a7a",id:"clearAll"}]},{UIType:"Toolbar",id:"toolbar1",children:[{UIType:"buttonGroup",id:"buttonGroup3",name:"actions",buttonType:"button",appendClass:"btn-group-toolbtn",buttons:[{title:"\u64a4\u9500",id:"undo"},{title:"\u91cd\u505a",id:"redo"}]}]}]},{UIType:"panel",title:"\u6750\u6599",name:"tools",id:"panel2",overflow:"hidden",children:[{UIType:"buttonGroup",
title:"",id:"buttonGroupTexturesType",name:"texturesType",buttons:[{title:"\u8d34\u56fe",id:"imageTexture",checked:!0},{title:"\u989c\u8272",id:"colorTexture"}]},{UIType:"buttonGroup",title:"\u6750\u6599",id:"buttonGroup2",name:"textures",appendClass:"btn-group-rect",buttons:[{title:"",id:"texture0",bgType:ra[0].type,bgTypeData:ra[0].uniqueData,width:50,height:50,checked:!0}]}]}]};if(600>h.WINDOW_WIDTH){t=C.children;c=0;for(l=t.length;c<l;c++)if("sidebarResize"===t[c].id){c=t[c].buttons;t=0;for(l=
c.length;t<l;t++)"normalSidebar"===c[t].id&&delete c[t].checked,"minSidebar"===c[t].id&&(c[t].checked=!0);break}k.sidebarResize=1}else k.sidebarResize=0;GoUI.Utils.domCreationDirector(C);S.updateDom();l=g.querySelectorAll(".btn");if(l instanceof Array||l.length)for(c=l.length-1;0<=c;c--)l[c].addEventListener("click",ha,!1);else l instanceof object&&l.addEventListener("click",ha,!1);t=[{color:"#333333"},{color:"#7f7f7f"},{color:"#c3c3c3"},{color:"#ffffff"},{color:"#b97a57"},{color:"#ff7f27"},{color:"#880015"},
{color:"#ed1c24"},{color:"#ffaec9"},{color:"#ffc90e"},{color:"#fff200"},{color:"#efe4b0"},{color:"#22b14c"},{color:"#b5e61d"},{color:"#00a2e8"},{color:"#3f48cc"},{color:"#7092be"},{color:"#a349a4"},{color:"#c8bfe7"},{color:"#66ccff"},{color:"#ff6600"},{color:"#cc3333"},{color:"#ffcc33"},{color:"#33cc99"},{color:"#ff55cc"},{color:"#b1eb00"},{color:"#b1eb88"},{color:"#ff85cb"},{color:"#ff432e"}];c=0;for(l=t.length;c<l;c++)C={name:t[c].color,type:"color",id:"texture"+(c+1),uniqueData:t[c].color,data:new r.MeshLambertMaterial({color:t[c].color})},
ra.push(C),GoUI.map.buttonGroup2.addButton({title:"",id:C.id,bgType:C.type,bgTypeData:C.uniqueData,width:50,height:50}).addEventListener("click",ha,!1);t="texture/grass.png texture/sand.png texture/glass.png texture/rock.png texture/clay.png texture/dirt.png texture/bark.png texture/slats.png".split(" ");c=0;for(l=t.length;c<l;c++)C={name:t[c].replace("texture/","").replace(".png",""),type:"image",id:"texture"+ra.length,uniqueData:t[c],data:new r.MeshLambertMaterial({map:r.ImageUtils.loadTexture(t[c]),
transparent:!0})},"glass"===C.data.name&&(C.data.map.opacity=.3),C.data.map.magFilter=r.NearestFilter,C.data.map.minFilter=r.LinearMipMapLinearFilter,ra.push(C),GoUI.map.buttonGroup2.addButton({title:"",id:C.id,bgType:C.type,bgTypeData:C.uniqueData,width:50,height:50}).addEventListener("click",ha,!1);$("#loginUsername").on("keyup",function(a){13===a.which&&g.getElementById("login").click()});$("#loginPassword").on("keyup",function(a){13===a.which&&g.getElementById("login").click()});g.getElementById("login").addEventListener("click",
function(){var a=$("#loginUsername").val(),b=$("#loginPassword").val(),c=$("#login");c.attr("disabled","disabled");AV.User.current()&&AV.User.logOut();AV.User.logIn(a,b,{success:function(a){aa(!0);c.removeAttr("disabled");$("#loginModal").modal("hide");U("\u4f60\u597d"+AV.User.current().escape("username"));$("#loginUsername").val("");$("#loginPassword").val("");e.loadRemote()},error:function(a,b){$("#loginError").html(b.message);$("#loginError").parent().show();c.removeAttr("disabled")}})},!1);g.getElementById("signIn").addEventListener("click",
function(){var a=$("#signInEmail").val(),b=$("#signInUsername").val(),c=$("#signInPassword").val(),d=$("#signIn");d.attr("disabled","disabled");AV.User.current()&&AV.User.logOut();AV.User.signUp(b,c,{ACL:new AV.ACL,email:a},{success:function(a){aa(!0);d.removeAttr("disabled");$("#signInModal").modal("hide");U("\u4f60\u597d"+AV.User.current().escape("username"));$("#signInEmail").val("");$("#signInUsername").val("");$("#signInPassword").val("");e.loadRemote()},error:function(a,b){$("#signInError").html(b.message);
$("#signInError").parent().show();d.removeAttr("disabled")}})},!1);e.loadCamera(e.storageKeys.camera);e.loadSidebarSelectedButtons(e.storageKeys.sidebar);AV.User.current()?(aa(!0),(l=d.location.hash)?(l=l.substring(1),e.loadShared(l,function(){U("\u8f7d\u5165\u5206\u4eab\u6587\u4ef6\u5931\u8d25");e.loadRemote()})):e.loadRemote()):(aa(!1),(l=d.location.hash)?(l=l.substring(1),e.loadShared(l,function(){U("\u8f7d\u5165\u5206\u4eab\u6587\u4ef6\u5931\u8d25");e.loadMeshes(void 0,M,y.loadBoxAnimation)})):
e.loadMeshes(void 0,M,y.loadBoxAnimation));d.addEventListener("hashchange",function(){var a=d.location.hash;a&&(a=a.substring(1),e.loadShared(a,function(){U("\u8f7d\u5165\u5206\u4eab\u6587\u4ef6\u5931\u8d25")}))},!1)})(window,document,Base,THREE,Detector);
